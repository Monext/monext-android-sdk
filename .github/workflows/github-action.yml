name: Monext Online Android SDK CI/CD Pipeline

# DÃ‰CLENCHEURS - Quand ce pipeline doit s'exÃ©cuter
on:
  # Se dÃ©clenche lors d'un push sur les branches main ou develop
  push:
    branches: [ main, develop ]
    # Se dÃ©clenche aussi lors de la crÃ©ation d'un tag commenÃ§ant par 'v' (ex: v1.0.0)
    tags:
      - 'v*'
  # Se dÃ©clenche lors de l'ouverture ou mise Ã  jour d'une Pull Request
  pull_request:
    branches: [ develop ]

# VARIABLES GLOBALES - UtilisÃ©es dans tous les jobs
env:
  ANDROID_COMPILE_SDK: "34"
  ANDROID_BUILD_TOOLS: "34.0.0"
  ANDROID_SDK_TOOLS: "11076708"  # Version des outils de ligne de commande Android
  JDK_DISTRIBUTION: 'temurin'    # Distribution OpenJDK
  JDK_VERSION: '21'

jobs:
  # ============================================
  # TESTS UNITAIRES ET INSTRUMENTÃ‰S
  # ============================================
  test:
    name: Run Tests
    # Machine virtuelle Ubuntu pour exÃ©cuter les tests
    runs-on: ubuntu-latest

    steps:
      # RÃ©cupÃ¨re le code source depuis GitHub
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # fetch-depth: 0 rÃ©cupÃ¨re tout l'historique Git
          # NÃ©cessaire pour que SonarCloud puisse analyser les changements
          fetch-depth: 0

      # Configure JDK
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JDK_DISTRIBUTION }}
          java-version: ${{ env.JDK_VERSION }}
          cache: 'gradle'  # Met en cache les dÃ©pendances Gradle pour accÃ©lÃ©rer les builds

      # Installe le SDK Android nÃ©cessaire pour compiler
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: ${{ env.ANDROID_SDK_TOOLS }}

      # Rend le wrapper Gradle exÃ©cutable (nÃ©cessaire sur Linux)
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Setup Google Services
        uses: ./.github/actions/setup-google-services
        with:
          firebase_app_id: ${{ secrets.FIREBASE_APP_ID }}
          firebase_api_key: ${{ secrets.FIREBASE_APP_ID }}

      # ============================================
      # TESTS UNITAIRES (tests sur la JVM, sans Android)
      # ============================================
      # Tests unitaires ET gÃ©nÃ©ration du rapport JaCoCo
      - name: Run unit tests with coverage
        run: ./gradlew testDebugUnitTest --stacktrace

      # Sauvegarde les rapports de tests mÃªme si les tests Ã©chouent
      - name: Upload unit test results
        uses: actions/upload-artifact@v4
        if: always()  # S'exÃ©cute mÃªme en cas d'Ã©chec
        with:
          name: unit-test-results
          path: |
            **/build/reports/tests/
            **/build/reports/jacoco/
            **/build/outputs/unit_test_code_coverage/

      # ============================================
      # TESTS Android
      # ============================================
      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      # Tests d'instrumentation sur Ã©mulateur
      - name: Start emulator and run instrumented tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          # Configuration de l'Ã©mulateur
          api-level: 30
          arch: x86_64
          profile: Nexus 6
          avd-name: test
          # Options pour optimiser l'Ã©mulateur en CI (pas d'interface graphique)
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
          disable-animations: true  # DÃ©sactive les animations pour accÃ©lÃ©rer les tests
          # Commande Ã  exÃ©cuter une fois l'Ã©mulateur dÃ©marrÃ©
          script: ./gradlew createDebugCoverageReport --stacktrace

      # Sauvegarde les rÃ©sultats des tests instrumentÃ©s
      - name: Upload instrumented test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: instrumented-test-results
          path: |
            **/build/reports/androidTests/
            **/build/reports/coverage/
            **/build/outputs/code_coverage/

      # Genere un rapport qui combine les TU et les AndroidTest
      - name: Generate unified coverage report
        run: |
          ./gradlew jacocoTestReport --stacktrace
          echo "Coverage report generated at: monext/build/reports/jacoco/jacocoTestReport/"

      - name: Upload JaCoCo report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: jacoco-report
          path: '**/build/reports/jacoco/'

  # ============================================
  # ANALYSE SONARCLOUD
  # ============================================
  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    # Ne s'exÃ©cute qu'aprÃ¨s le succÃ¨s des tests
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Historique complet pour l'analyse

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JDK_DISTRIBUTION }}
          java-version: ${{ env.JDK_VERSION }}
          cache: 'gradle'

      - name: Setup Google Services
        uses: ./.github/actions/setup-google-services
        with:
          firebase_app_id: ${{ secrets.FIREBASE_APP_ID }}
          firebase_api_key: ${{ secrets.FIREBASE_APP_ID }}

      # Cache pour les packages SonarCloud (accÃ©lÃ¨re l'analyse)
      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      # TÃ©lÃ©charge les artifacts des tests (incluant JaCoCo)
      - name: Download test artifacts
        uses: actions/download-artifact@v4
        with:
          path: build-artifacts

      - name: Restore coverage files
        run: |
          cp -r build-artifacts/jacoco-report/* ./ 2>/dev/null || true
          cp -r build-artifacts/unit-test-results/* ./ 2>/dev/null || true
          cp -r build-artifacts/instrumented-test-results/* ./ 2>/dev/null || true

      - name: Check coverage report
        run: |
          echo "Checking for coverage files..."
          find . -name "*.exec" -type f
          find . -name "*.ec" -type f
          find . -name "jacocoTestReport.xml" -type f

      # Build minimal puis Sonar
      - name: Run SonarCloud analysis
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          ./gradlew assembleDebug --stacktrace
          ./gradlew sonar --info -x test -x testDebugUnitTest


  # ============================================
  # ============================================
  # BUILD ET PUBLICATION DU SDK => Release uniquement
  # => DÃ©ploiement sonatype + github release
  # ============================================
  # ============================================
  build-and-publish-release:
    name: Build and Publish SDK
    runs-on: ubuntu-latest
    needs: [test, sonarcloud]
    if:
      contains('
      refs/heads/main
      refs/heads/master
      refs/heads/release
      ', github.ref)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JDK_DISTRIBUTION }}
          java-version: ${{ env.JDK_VERSION }}
          cache: 'gradle'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: ${{ env.ANDROID_SDK_TOOLS }}

      - name: Decode and save keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 -d > ${{ github.workspace }}/keystore.jks

      - name: Setup Google Services
        uses: ./.github/actions/setup-google-services
        with:
          firebase_app_id: ${{ secrets.FIREBASE_APP_ID }}
          firebase_api_key: ${{ secrets.FIREBASE_APP_ID }}

      - name: Build Release AAR
        run: ./gradlew :monext:assembleRelease
        env:
          THREEDS_API_ACCESS_KEY: ${{ secrets.THREEDS_API_ACCESS_KEY }}

      - name: Generate documentation
        run: ./gradlew :monext:dokkaHtml

      - name: Upload AAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: sdk-aar
          path: monext/build/outputs/aar/*.aar

      # RÃ‰CUPÃ‰RATION DE LA VERSION
      - name: Get Version
        id: version
        uses: ./.github/actions/setup-sdk-version

#      # Publication sur Maven Central
#      - name: Publish to Maven Central
#        run: ./gradlew :monext:publishReleasePublicationToMavenCentralRepository
#        env:
#          MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
#          MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
#          SIGNING_KEY_ID: ${{ secrets.SIGNING_KEY_ID }}
#          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
#          SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
#          THREEDS_API_ACCESS_KEY: ${{ secrets.THREEDS_API_ACCESS_KEY }}
#

#      # Publication sur GitHub Packages
      - name: Create GitHub Release
#        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            monext/build/outputs/aar/*.aar
            CHANGELOG.md
          generate_release_notes: true
          draft: true # TODO : A voir quand Maven central sera ok
          prerelease: false
          tag_name: ${{ github.ref_name }}
          name: Monext Online Android SDK Release v${{ steps.version.outputs.VERSION_NAME }}
          #  Permet de mettre Ã  jour une release existante si elle existe dÃ©jÃ 
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


  # ============================================
  # ============================================
  # BUILD ET DISTRIBUTION QA (branche develop)
  # ============================================
  # ============================================
  build-apk-qa-release:
    name: Build App Demo QA Release
    runs-on: ubuntu-latest
    needs: [test, sonarcloud]
    # Uniquement sur develop ET si les tests passent
    if: github.ref == 'refs/heads/develop' && needs.test.result == 'success' && needs.sonarcloud.result == 'success'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JDK_DISTRIBUTION }}
          java-version: ${{ env.JDK_VERSION }}
          cache: 'gradle'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: ${{ env.ANDROID_SDK_TOOLS }}

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # ============================================
      # RÃ‰CUPÃ‰RATION DE LA VERSION
      # ============================================
      - name: Get Version
        id: version
        uses: ./.github/actions/setup-sdk-version

      - name: Setup Google Services
        uses: ./.github/actions/setup-google-services
        with:
          firebase_app_id: ${{ secrets.FIREBASE_APP_ID }}
          firebase_api_key: ${{ secrets.FIREBASE_CURRENT_KEY }}

      - name: Decode and save keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > ${{ github.workspace }}/keystore.jks
          echo "âœ“ Keystore decoded"

      # ============================================
      # BUILD DE L'APP DÃ‰MO (compile automatiquement le SDK et signe l'APK)
      # ============================================
      - name: Build Demo App and SDK
        run: |
          echo "ðŸ“± Building app (will automatically build SDK in Release mode)..."
          ./gradlew :app:assembleRelease --info
          echo "âœ“ Build completed successfully!"
        env:
          THREEDS_API_ACCESS_KEY: ${{ secrets.THREEDS_API_ACCESS_KEY }}
          KEYSTORE_PATH: ${{ github.workspace }}/keystore.jks
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      # ============================================
      # PRÃ‰PARATION de l'APK + release note
      # ============================================
      - name: Prepare artifacts
        run: |
          mkdir -p qa-release
          
          # Copier l'APK de l'app demo
          cp app/build/outputs/apk/release/*.apk qa-release/
          
          # RÃ©cupÃ©ration du fileName
          APK_FILE=$(find qa-release -name "*.apk" | head -1)
          APK_FILENAME=$(basename "$APK_FILE")
          
          # CrÃ©er le fichier de release notes
          cat > qa-release/RELEASE_NOTES.txt <<EOF
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ðŸ“± MONEXT DEMO APP (Android SDK) - Version QA
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ðŸ“± Fichier APK
          Nom original: ${APK_FILENAME}
          Taille: $(du -h "$APK_FILE" | cut -f1)
          
          Version SDK    : ${{ steps.version.outputs.VERSION_NAME }}
          Build Number   : ${{ steps.version.outputs.VERSION_CODE }}
          Branch         : ${{ github.ref_name }}
          Date           : $(date +'%Y-%m-%d %H:%M:%S')
          Auteur         : ${{ github.actor }}
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ðŸ“ Changements rÃ©cents:
          ${{ steps.commit_info.outputs.message }}
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          EOF
        
          echo "âœ“ Artefacts prÃ©parÃ©s"
          ls -lh qa-release/

      # ============================================
      # FIREBASE APP DISTRIBUTION
      # ============================================
      - name: Setup Node.js (for Firebase CLI)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Setup Firebase Authentication
        run: |
          # RecupÃ©ration du Service Account pour la connexion
          echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT_BASE64 }}" | base64 -d > firebase-sa.json
          
          # DÃ©finir la variable d'environnement
          echo "GOOGLE_APPLICATION_CREDENTIALS=${{ github.workspace }}/firebase-sa.json" >> $GITHUB_ENV
          echo "âœ“ Firebase authentication configured"

      - name: Upload to Firebase App Distribution
        run: |
          APK_FILE=$(find qa-release -name "*.apk" | head -1)
          APK_FILENAME=$(basename "$APK_FILE")
          
          echo "ðŸ“¤ Uploading ${APK_FILENAME} to Firebase..."
          
          firebase appdistribution:distribute "$APK_FILE" \
            --app "${{ secrets.FIREBASE_APP_ID }}" \
            --groups "qa-team, squad3, monext-android" \
            --release-notes-file "qa-release/RELEASE_NOTES.txt"
          
          echo "âœ… APK uploaded successfully to Firebase App Distribution"

      - name: Cleanup files
        if: always()
        run: |
          rm -f ${{ github.workspace }}/keystore.jks
          rm -f ${{ github.workspace }}/firebase-sa.json
          rm -f app/google-services.json
          echo "âœ“ Cleanup completed"

  # ============================================
  # ============================================
  # NOTIFICATIONS Teams
  # ============================================
  # ============================================
  notify:
    name: Teams Notification
    runs-on: ubuntu-latest
    if: always()
    needs: [test, sonarcloud, build-apk-qa-release, build-and-publish-release]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Version
        id: version
        uses: ./.github/actions/setup-sdk-version

      # ============================================
      # CHECK 1 : Check Notification QA
      # ============================================
      - name: Should send QA Notification
        id: teams_notif_qualif
        if: |
          github.ref == 'refs/heads/develop' &&
          needs.test.result == 'success' &&
          needs.sonarcloud.result == 'success'
        run: |
          TEAMS_WEBHOOK_URL="${{ secrets.TEAMS_WEBHOOK_URL_QUALIF }}"
          SHOULD_SEND="yes"
          NOTIFICATION_TYPE="QA"
          
          echo "webhook_url=${TEAMS_WEBHOOK_URL}" >> $GITHUB_OUTPUT
          echo "should_send=${SHOULD_SEND}" >> $GITHUB_OUTPUT
          echo "notif_type=${NOTIFICATION_TYPE}" >> $GITHUB_OUTPUT
          echo "Should send QA notification => ${SHOULD_SEND}"

      # ============================================
      # CHECK 2 : Check Notification Release
      # ============================================
      - name: Should send Release Notification
        id: teams_notif_release
        if: |
          (github.ref == 'refs/heads/main' || 
           github.ref == 'refs/heads/master' || 
           startsWith(github.ref, 'refs/heads/release/') ||
           startsWith(github.ref, 'refs/tags/v'))
        run: |
          TEAMS_WEBHOOK_URL="${{ secrets.TEAMS_WEBHOOK_URL_SDK_MOBILE }}"
          SHOULD_SEND="yes"
          NOTIFICATION_TYPE="Release"
          BUILD_RESULT="${{ needs.build-and-publish-release.result }}"
          
          # Check du statut
          if [[ "$BUILD_RESULT" == "success" ]]; then
          ICON_COLOR="Good"
          ICON="CheckmarkStarburst"
          STATUS_TEXT="âœ… success"
          elif [[ "$BUILD_RESULT" == "failure" ]]; then
          ICON_COLOR="Attention"
          ICON="DismissCircle"
          STATUS_TEXT="âŒ Ã‰chec"
          else
          ICON_COLOR="Warning"
          ICON="Warning"
          STATUS_TEXT="âš ï¸ Unknow"
          fi
          
          # On passe les variables via outputs
          echo "webhook_url=${TEAMS_WEBHOOK_URL}" >> $GITHUB_OUTPUT
          echo "should_send=${SHOULD_SEND}" >> $GITHUB_OUTPUT
          echo "notif_type=${NOTIFICATION_TYPE}" >> $GITHUB_OUTPUT
          echo "icon_color=${ICON_COLOR}" >> $GITHUB_OUTPUT
          echo "icon=${ICON}" >> $GITHUB_OUTPUT
          echo "status_text=${STATUS_TEXT}" >> $GITHUB_OUTPUT
          
          echo "Should send Release notification => ${SHOULD_SEND} (status: ${STATUS_TEXT})"

      # ============================================
      # ENVOI DE LA NOTIFICATION (un seul step)
      # ============================================
      - name: Send Teams Notification
        # âœ… S'exÃ©cute si AU MOINS UN des deux checks dit "yes"
        if: |
          steps.teams_notif_qualif.outputs.should_send == 'yes' ||
          steps.teams_notif_release.outputs.should_send == 'yes'
        run: |
          # âœ… RÃ©cupÃ©rer les variables depuis les outputs
          if [[ "${{ steps.teams_notif_qualif.outputs.should_send }}" == "yes" ]]; then
            WEBHOOK_URL="${{ steps.teams_notif_qualif.outputs.webhook_url }}"
            NOTIF_TYPE="${{ steps.teams_notif_qualif.outputs.notif_type }}"
            ICON_COLOR="Good"
            ICON="CheckmarkStarburst"
            STATUS_TEXT="âœ… QA Release disponible"
            EXTRA_MESSAGE="ðŸ“± L'APK est maintenant disponible sur Firebase App Distribution. Les testeurs ont reÃ§u une notification automatique."
            FIREBASE_ACTION='
                      {
                        "type": "Action.OpenUrl",
                        "title": "ðŸ“± Ouvrir Firebase Console",
                        "url": "https://console.firebase.google.com/project/monext-android-sdk/appdistribution/app/android:com.monext.sdkexample/releases"
                      },'
          else
            WEBHOOK_URL="${{ steps.teams_notif_release.outputs.webhook_url }}"
            NOTIF_TYPE="${{ steps.teams_notif_release.outputs.notif_type }}"
            ICON_COLOR="${{ steps.teams_notif_release.outputs.icon_color }}"
            ICON="${{ steps.teams_notif_release.outputs.icon }}"
            STATUS_TEXT="${{ steps.teams_notif_release.outputs.status_text }}"
            EXTRA_MESSAGE="Publication sur Maven Central et GitHub Packages."
            FIREBASE_ACTION=""
          fi
          
          echo "Sending ${NOTIF_TYPE} notification to Teams..."
          
          curl -X POST "${WEBHOOK_URL}" \
               -H "Content-Type: application/json" \
               -d @- << EOF
          {
            "type": "message",
            "attachments": [
              {
                "contentType": "application/vnd.microsoft.card.adaptive",
                "contentUrl": null,
                "content": {
                  "type": "AdaptiveCard",
                  "\$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                  "version": "1.4",
                  "body": [
                    {
                      "type": "ColumnSet",
                      "columns": [
                        {
                          "type": "Column",
                          "width": "auto",
                          "height": "stretch",
                          "items": [
                            {
                                "type": "Icon",
                                "name": "${ICON}",
                                "style": "Filled",
                                "color": "${ICON_COLOR}"
                              }
                          ],
                          "spacing": "None"
                        },
                        {
                          "type": "Column",
                          "width": "stretch",
                          "items": [
                            {
                              "type": "TextBlock",
                              "text": "Publication **SDK Android** - ${STATUS_TEXT}",
                              "wrap": true,
                              "size": "Large",
                              "weight": "Bolder"
                            }
                          ],
                          "spacing": "Small"
                        }
                      ],
                      "spacing": "None"
                    },
                    {
                      "type": "TextBlock",
                      "text": "_version ${{ steps.version.outputs.VERSION_NAME }} (build ${{ steps.version.outputs.VERSION_CODE }})_",
                      "wrap": true,
                      "isSubtle": true,
                      "spacing": "Small"
                    },
                    {
                      "type": "FactSet",
                      "facts": [
                        {
                          "title": "Repository:",
                          "value": "${{ github.repository }}"
                        },
                        {
                          "title": "Branch/Tag:",
                          "value": "${{ github.ref_name }}"
                        },
                        {
                          "title": "Auteur:",
                          "value": "${{ github.actor }}"
                        }
                      ],
                      "separator": true
                    },
                    {
                      "type": "TextBlock",
                      "text": "${EXTRA_MESSAGE}",
                      "wrap": true,
                      "separator": true
                    }
                  ],
                  "actions": [
                    ${FIREBASE_ACTION}
                    {
                      "type": "Action.OpenUrl",
                      "title": "ðŸ“Š Voir le build",
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              }
            ]
          }
          EOF
          
          echo "âœ… ${NOTIF_TYPE} notification sent successfully"